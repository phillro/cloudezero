<html xmlns="http://www.w3.org/1999/html">
<head>
  <title>#external festivus</title>
  <!-- css -->
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
  <link rel='stylesheet' href='/stylesheets/chat.css'/>
  <link rel="stylesheet" href='/stylesheets/reveal.css'/>

  <!-- js -->
  <script src='//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
  <script src='/javascripts/jquery.dateFormat-1.0.js' type='text/javascript'></script>
  <script src='/javascripts/handlebars.js' type='text/javascript'></script>
  <script src='/socket.io/socket.io.js'></script>

  <!-- templates -->
  <script id='chat-message-template' type='text/x-handlebars-template'>
    <span class="chat-nickname"><em>{{nickname}}</em></span> Â» <span class="chat-message">{{message}}</span><br>
  </script>

  <script type="text/javascript">
    var chatMessageTemplate = Handlebars.compile($('#chat-message-template').html());

    // open socket for live updates
    var socket = io.connect();

    // set up socket handlers
    socket.on('updates', function (data) {
      // new chat message
      if (data.channel === 'chat') {
        rcvMessage(JSON.parse(data.message));
      }
    });

    function rcvMessage(message) {
      var newMessage = chatMessageTemplate({
        nickname:message.nickname,
        message:message.message
      });

      $('#chat-container').append(newMessage);
      $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
    }

    // send message
    function addMessage(inputBox, event) {
      if (event.which == 13) {
        $.post('/chat/addMessage', {message:inputBox.value}, function () {
          inputBox.value = '';
        });
      }
      else {
        return true;
      }
    }

    $(document).ready(function () {
      $.get('/chat/getMessages', function (docs) {
        for (var i = 0; i < docs.length; i++) {
          rcvMessage(docs[i]);
        }
      });
    });
  </script>
</head>
<body>
<div id='chat-container'></div>
<div id='chat-controls'>
  <input id="chat-input" size="94" onkeypress="return addMessage(this, event);">
</div>
</body>
</html>